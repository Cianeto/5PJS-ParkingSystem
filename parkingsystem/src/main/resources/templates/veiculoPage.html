<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.png" />
    <meta charset="UTF-8" />
    <title>Parking System</title>
    <link rel="stylesheet" href="/css/index.css" />
  </head>
  <body>
    <h1>Cliente: <span th:text="${cliente.nome}"></span></h1>

    <form id="veiculoForm" method="post">
      <fieldset>
        <legend>Informações do Veículo</legend>

        <label for="modelo">Modelo:</label><br />
        <input
          required
          type="text"
          id="modelo"
          name="modelo"
          placeholder="Ex: Honda Civic"
        /><br />

        <label for="placa">Placa:</label><br />
        <input
          required
          type="text"
          id="placa"
          name="placa"
          pattern="[A-Za-z0-9]{7}"
          placeholder="Ex: ABC1234"
          oninput="this.value = this.value.toUpperCase()"
        /><br />

        <label for="porte">Porte:</label><br />
        <select id="porte" name="porte" required>
          <option value="">Selecione o porte</option>
          <option value="Pequeno">Pequeno</option>
          <option value="Médio">Médio</option></select
        ><br />

        <input type="hidden" name="clienteId" th:value="${cliente.clienteId}" />

        <button type="submit" class="btn-submit">Cadastrar novo veículo</button>
      </fieldset>
    </form>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Veiculo ID</th>
            <th>Modelo</th>
            <th>Placa</th>
            <th>Porte</th>
            <th>Fazer Reserva</th>
            <th>Deletar Veiculo</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="veiculo : ${veiculos}">
            <td th:text="${veiculo.veiculo_id}"></td>
            <td th:text="${veiculo.modelo}"></td>
            <td th:text="${veiculo.placa}"></td>
            <td th:text="${veiculo.porte}"></td>
            <td>
              <a class="btn" th:attr="onclick='reservar(\'' + ${veiculo.veiculo_id} + '\')'">Reservar</a>
            </td>
            <td>
              <button
                class="btn"
                th:onclick="'deleteVeiculo(' + ${veiculo.veiculo_id} + ');'"
              >
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ReservaID</th>
            <th>Horário de Entrada</th>
            <th>Horário de Saída</th>
            <th>Tarifa</th>
            <th>Status</th>
            <th>Comentário</th>
            <th>Placa</th>
            <th>Veículo ID</th>
            <th>Finalizar</th>
            <th>Problema</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="dto : ${reservas}"  >
            <td th:text="${dto.reserva.reservaId}"></td>
            <td th:text="${dto.reserva.horarioEntrada}"></td>
            <td th:text="${dto.reserva.horarioSaida}"></td>
            <td th:text="${dto.reserva.tarifa}"></td>
            <td id="status" th:text="${dto.reserva.reservaStatus}"></td>
            <td th:text="${dto.reserva.commentary}"></td>
            <td th:text="${dto.placa}"></td>
            <td th:text="${dto.reserva.veiculoId}"></td>
            <td> <!-- POSSUIMOS 3 OPCOES: COLOCAR A MODEL NAS MODELS -->
              <button
                class="btn"
                
                th:attr="onclick='finalizar(\'' + ${dto.reserva} + '\')'"
              >
              <!-- th:onclick="'finalizar(' + ${dto.reserva.reservaId} + ')'" -->
                Finalizar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // INSERIR VEICULO (
      document
        .getElementById("veiculoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          fetch("/insertVeiculo", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              console.log(response);
              window.location.reload();
            })
            .catch((error) =>
              console.error(
                "There has been a problem with your fetch operation:",
                error
              )
            );
        });
      // )

      // DELETAR VEICULO (
      function deleteVeiculo(id) {
        fetch("/deleteVeiculo/" + id, { method: "DELETE" }).then((response) => {
          console.log(response);
          window.location.reload();
        });
      }
      // )

      // INSERIR RESERVA (
      function reservar(id) {
        console.log(id);
        fetch("/insertReserva?veiculoId=" + id, { method: "POST" })
          .then((response) => {
            if (response.ok) {
              console.log("Reserva feita com sucesso.");
              window.location.reload(); // Recarrega a página após a reserva
            } else {
              console.error("Erro ao fazer reserva.");
            }
          })
          .catch((error) =>
            console.error("Houve um problema com a operação fetch:", error)
          );
      }
      // )

      // FINALIZAR RESERVA (
      function finalizar(reservaStr) {
        console.log(reservaStr)
        const reserva = reservaStr.slice(reservaStr.indexOf('(') + 1, reservaStr.length - 1)
            .split(', ')
            .reduce((acc, current) => {
                const [key, value] = current.split('=');
                acc[key] = value;
                return acc;
            }, {});
        console.log(reserva)
        var status = reserva.reservaStatus;
        console.log(status)
        if(status == 'FINALIZADO'){
            return;
        }
        console.log("reserva id" + reserva.reservaId)
        fetch("/confirmarPagamento?reservaId=" + reserva.reservaId, { method: "POST" })
          .then((response) => {
            if (response.ok) {
              console.log("Reserva finalizada com sucesso.");
              window.location.reload();
            } else {
              console.error("Erro ao finalizar reserva:", response.statusText);
            }
          })
          .catch((error) =>
            console.error("Houve um problema com a operação fetch:", error)
          );
      }
      // )
    </script>

    <!-- <script src="/js/"></script> -->
  </body>
</html>
